script_dir = '../../scripts'
data_dir = 'snakemake_data'

read_length = 150
k = 7
ref_scale = 10
query_scale = 1
threshold_bp = 50
num_organisms = 30
num_genomes_full_db = 30
num_genomes_truncated_db = 20
genome_path = '../extracted_genomes_from_kegg'
num_reads_list = ['40000', '50000']


rule run_diamond:
    input:
        script_dir+'/classify_diamond.py',
        script_dir+'/calculate_diamond_performance.py',
        data_dir+'/protein_ref_truncated.faa',
        expand(data_dir+'/simulated_metagenome_num_reads_{num_reads}.fastq', num_reads=num_reads_list),
        expand(data_dir+'/ground_truth_num_reads_{nr}.csv', nr=num_reads_list)
    output:
        expand( data_dir+'/diamond_output_file_num_reads_{nr}', nr=num_reads_list ),
        expand( data_dir+'/diamond_performance_metrics_num_reads_{nr}', nr=num_reads_list )
    benchmark:
        data_dir+'/diamond_benchmark'
    run:
        for num_reads in num_reads_list:
            cmd = 'python {input[0]} -r %s -m %s -o %s' % ( data_dir+'/protein_ref_truncated.faa', data_dir+'/simulated_metagenome_num_reads_%s.fastq'%(num_reads), data_dir+'/diamond_output_file_num_reads_'+num_reads )
            shell(cmd)
            cmd = 'python {input[1]} -g %s -s %s -o %s' % ( data_dir+'/ground_truth_num_reads_%s.csv'%(num_reads), data_dir+'/diamond_output_file_num_reads_'+num_reads, data_dir+'/diamond_performance_metrics_num_reads_'+num_reads )
            shell(cmd)


rule get_sourmash_results:
    input:
        script_dir+'/calculate_sourmash_performance.py',
        expand(data_dir+'/ground_truth_num_reads_{nr}.csv', nr=num_reads_list),
        expand(data_dir+'/sourmash_gather_num_reads{num_reads}', num_reads=num_reads_list)
    output:
        expand(data_dir+'/sourmash_performance_metrics_num_reads_{nr}', nr=num_reads_list)
    run:
        for num_reads in num_reads_list:
            cmd = '{input[0]} -g %s -s %s -o %s' % ( data_dir+'/ground_truth_num_reads_%s.csv'%(num_reads), data_dir+'/sourmash_gather_num_reads'+num_reads, data_dir+'/sourmash_performance_metrics_num_reads_'+num_reads )
            shell(cmd)

rule run_sourmash:
    input:
        script_dir + '/classify_sourmash.py',
        data_dir+'/protein_ref_truncated.faa',
        expand( data_dir + '/simulated_metagenome_num_reads_{num_reads}.fastq', num_reads=num_reads_list )
    output:
        expand(data_dir+'/sourmash_gather_num_reads{num_reads}', num_reads=num_reads_list)
    benchmark:
        data_dir + "/sourmash_gather_benchmark"
    run:
        for num_reads in num_reads_list:
            cmd = '{input[0]} -r %s -m %s -o %s -k %s --ref_scale_size %s --query_scale_size %s --query_translate -t %s -g %s' % (data_dir+'/protein_ref_truncated.faa', data_dir + '/simulated_metagenome_num_reads_' + num_reads + '.fastq', data_dir, str(k), str(ref_scale), str(query_scale), str(threshold_bp), data_dir+'/sourmash_gather_num_reads' + num_reads)
            print(cmd)
            shell(cmd)

rule create_ground_truth:
    input:
        script_dir + '/find_genes_in_sim.py',
        expand(data_dir + '/simulated_metagenome_num_reads_{num_reads}.fastq', num_reads=num_reads_list),
    output:
        expand(data_dir + '/ground_truth_num_reads_{nr}.csv', nr=num_reads_list)
    run:
        for num_reads in num_reads_list:
            shell('python {input[0]} --database_dir ' + genome_path + ' --simulation ' + data_dir + '/simulated_metagenome_num_reads_' + num_reads + '.fastq --output_file ' + data_dir + '/ground_truth_num_reads_' + num_reads + '.csv' + ' --num_genomes ' + str(num_genomes_full_db))


rule create_metagenomes:
    input:
        script_dir + '/simulate_metagenome.py',
        data_dir + '/genome_ref_full.fa'
    output:
        expand(data_dir + '/simulated_metagenome_num_reads_{num_reads}.fastq', num_reads=num_reads_list)
    run:
        for num_reads in num_reads_list:
            shell("python {input[0]} -r {input[1]} -o " + data_dir + "/simulated_metagenome_num_reads_" + num_reads + ".fastq -n " + num_reads + " -l " + str(read_length) + " --num_orgs " + str(num_organisms))


rule setup_initials:
    input:
        "setup.sh",
        script_dir + '/create_genome_ref_db.py'
    output:
        data_dir + '/genome_ref_full.fa',
        data_dir + '/genome_ref_truncated.fa',
        data_dir + '/protein_ref_full.faa',
        data_dir + '/protein_ref_truncated.faa'
    shell:
        'bash {input[0]} ' + script_dir + ' ' + data_dir + ' ' + str(num_genomes_full_db) + ' ' + str(num_genomes_truncated_db) + ' ' + str(read_length) + ' ' + str(k) + ' ' + str(ref_scale) + ' ' + str(query_scale) + ' ' + str(threshold_bp) + ' ' + genome_path
